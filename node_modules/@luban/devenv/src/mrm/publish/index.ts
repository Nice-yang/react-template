import {lines, packageJson, MrmError} from "mrm-core";
import MrmTask from "../../types/MrmTask";

const task: MrmTask = function publish() {
    const pkgJson = packageJson();
    const name: string = pkgJson.get("name", "");
    if (name === "") {
        throw new MrmError("Package name is not defined");
    }
    if (name.startsWith("@")) {
        if (!name.startsWith("@luban")) {
            throw new MrmError("Package should belong to @luban scope");
        }
    } else {
        pkgJson.set("name", `@luban/${name}`);
    }
    pkgJson
        .set("types", "dist/index.d.ts")
        .appendScript("prepublishOnly", "yarn build:clean")
        .set("publishConfig.registry", "http://192.168.13.238:8081/repository/npm-luban/")
        .save();

    // 设置npmignore, 将dist发布出去
    lines(".npmignore").add("!dist/").save();
};
task.description = "Add publish config for Luban developer";
export = task;
