# 代码规范

## 原则

- 基于airbnb的js代码规范进行调整

- 加上Typescript专用代码规范

- 统一代码风格

- 减少git变更

- 增加代码可读性，不依赖对编译器、解析器结合顺序，优先级等的理解

- 更加语义化的代码

- 尽量使用新的语法

- 减少无用的模板代码(占位)

- 使代码更紧凑

- 不要复杂的规则

- 所有规则可以通过工具自动检查

- 大部分格式规则可以通过工具自动修复

- 当和上述所有原则都不冲突的情况下，根据规范编制者的个人喜好决定

    

*示例代码中如果与规则有冲突，以规则为准*

## 代码风格

*代码风格规定的是出于可读性、美观、减少git变更等目的的规则，并不会产生错误或潜在错误。这部分如果有其他的写法，并不存在为什么那样写不行的问题*

### 文件

1. 文件中不要有BOM
2. 换行使用LF而不是CRLF
3. 单文件不超过1000行
4. 每个文件只声明一个class
5. 文件名应该和default export的名字一样（大小写也一致）。注意：windows的文件名不分大小写，但是linux上区分，所以如果import的文件名大小写错误，会导致在windows上build成功，但是在linux上build失败

### 缩进

1. 使用空格而不是tab缩进
2. 缩进4字节

### 括号

1. {}的外部，和相邻语句模块在同一行，{}外部和其他语句用空格隔开

    ```typescript
    if (xxx) {
        //code
    } else {
        //code
    }
    ```

2. 只占一行的block，{}内要有空格

    ```typescript
    if (a) { console.log(a) };
    ```

3. 其他使用括号的情况，括号内不需要空格，例如

    ```typescript
    a[1] = 0;
    a[key] = 0;
    func(a);
    const b = {a:0};
    
    ```


### 换行/空行

1. 单行长度不超过140字符，超过需要换行（url、字符串、正则表达式除外）
2. 每行只写一个语句
3. 函数参数，对象，数组的括号内的内容，如果有多行的情况下，每行只有一个元素。
4. 当左右括号不在同一行的时候，括号内需要换行
5. 箭头函数如果不是一个block，不要在箭头后面换行
6. 文件末是一个空行
7. 类成员之间用空行隔开
8. 三元运算符不要换行，如果一行写不下，则冒号两侧的语句都应该独自占一行
9. 不要有过多的连续空行（最大3)，文件头不要有空行
10. 一个代码块的头部和末尾不要有多余的空行
11. 如果一个表达式不能写在一行里面，则在运算符前面换行（赋值运算符除外，赋值运算的两边都不应该换行）
12. 类成员运算符`.`如果遇到换行，放在下一行

### 空格

1. 不要有连续的空格

2. 行末不要有空格

3. 逗号，分号，冒号前不要有空格，后面加空格

4. .和…运算符前后不要有空格

5. 双目运算符，前后都要有空格：+ - * / => >> << >= <= == ？: 等

6. 单目运算符后不要加空格（new，typeof，instanceof 等认为是关键字，而不是单目运算符）

7. generator 和yield的*前面不要有空格，后面加空格

8. 函数名称和括号之间不要有空格，function关键字后面要加空格

9. 关键字的前后要加空格

10. 注释的内容和注释符号间加空格

11. 标签模板字符串，标签名和模板符号之间不要有空格

    ```typescript
    //正确
    const a = tag`${1}`;
    
    //错误
    const a = tag `${1}`;
    ```

    

### 逗号

1. 逗号遇到换行的时候，逗号写在行末
2. 数组、对象、函数参数等应该用逗号隔开的内容，当不能放在一行内时，最后一个元素后面要有逗号

### 分号

1. 语句必须使用分号分开
2. 分号写在前一个语句的后面
3. 不要写多余的分号
4. 类和interface的成员末尾，用分号隔开，而不是用逗号
5. 类和interface的最后一个成员末尾的分号，如果类或interface不需要换行则忽略，否则保留

### 引号

1. 使用双引号
2. 声明对象属性的时候，仅在需要的时候使用引号

### 命名方式

1. 参数、变量使用小驼峰形式
2. 类使用大驼峰命名
3. interface不要使用I开头

### 对象

1. 访问对象属性，优先使用`.`运算符

2. 不要直接使用new Object(),而是使用 {}来创建一个新对象

3. new 对象时，即使没有参数，也需要写括号

    ```typescript
    //错误 
    const a = new MyClass;
    
    //正确
    const a = new MyClass();
    
    ```

    

### 函数

1. 链式调用时，一行不要超过4个成员
2. 函数的block深度不能超过5层
3. callback的深度不能超过3层
4. 箭头函数，如果只有一个返回语句，不要使用{}
5. 箭头函数的参数，即使只有一个参数，也总是使用()

### 类型

1. 数组类型使用T[]语法，而不是使用Array<T>语法
2. TS指定类型的时候，使用as 语法
3. 既可以使用interface又可以使用type来定义对象类型的时候，使用interface
4. 声明函数类型的时候，使用type而不是interface

### 其他

1. 每个变量/常量声明，只声明一个变量/常量

2. 总是将语句包在block里面

    ```typescript
    //错误
    if (a === 1) console.log(a);
    
    //正确
    if (a === 1) { console.log(a); }
    
    ```

    

## 语法规范

*语法规范规定的是良好的代码习惯和避免容易出错的代码。*

*良好的代码习惯可以提高代码质量，而另外一些情况则是某些写法容易引起和预想的不一样的效果或让阅读的人产生误解。*

*部分规则在实际过程中可能会有用处，但是往往会有其他更好的方式实现同样的目标*

### 禁用的语法

1. eval
2. ”use strict”
3. var
4. require
5. namespace
6. <///referenct …>
7. with
8. label
9. for..in
10. for..of
11. console
12. alert
13. 函数的arguments参数
14. 匿名Symbol
15. debugger
16. 多行字符串
17. 8进制数字常量
18. 全局的isNaN
19. 全局的isFinite
20. 全局的事件函数
21. continue
22. @ts-ignore
23. `xxx.prototype.__iterator__`
24. `__proto__`
25. `__defineGetter__`
26. `__defineSetter__`
27. Math.pow
28. URL里面使用`javascript:`
29. 逗号运算符

### 文件

1. 不能使用任何不可见的字符

### 语法

1. setTimeout的第一个参数必须是函数，不能使用字符串
2. parseInt必须传入第二个参数
3. 不要修改任何内建对象（只有polyfill的库才需要进行这样的操作）
4. 不要对系统全局对象进行赋值
5. 不要使用字符串和数字的相加

### 声明

1. 能够声明成const 的，声明成const

2. 能够用解构语法的，尽量使用解构语法

3. 除了箭头函数外，不要使用匿名函数

    ```typescript
    //错误
    const myFunc = function() {}
    ```

4. void只能用在类型定义中

5. 不能重复声明变量、函数、类

6. 嵌套的scope里面不能声明重复的变量、函数

7. 声明变量的时候，不需要将undefined赋值给变量

8. 不要在code block里面声明会影响block外的函数和变量（不用var不会有这样的情况）

9. const 和 let 不要穿插使用

10. 只有在需要使用的时候才声明变量/常量

11. 为变量、属性命名的时候，不要用下划线（函数参数可以以下划线开头，表明这个参数在函数中没有用到） 

12. 当一个值永远不会改变（包括其子属性）的时候，建议使用UPPER_SNAKE_CASE命名方式

### 常量/字面量

1. 不要使用parseInt来声明数字常量
2. 浮点数字面量，必须包含整数部分和小数部分
3. 不要使用new Array,Object, Boolean, String,Number来创建对应的对象
4. Symbol对象不能使用new 来创建

### 字符串

1. 不要使用字符串相加，使用模板字符串
2. 拼接字符串必须包含变量
3. 判断字符串的开头和结尾的内容的时候，使用startsWith和endsWith

### 运算符

1. 尽量避免使用位操作（检查工具会报警，但不产生错误）；注意，js的number是64位整数，但是位操作的返回值是32位整数
2. 不同类型的运算符，放在一个表达式里面的时候，加括号以增加可读性
3. 不要使用连续的赋值语句
4. 不要使用嵌套的三元运算符
5. 如果可以使用+= ， -=等运算符，则优先使用
6. 总是使用`===` 进行判断，而不是`==`
7. 不要delete一个变量
8. in 和 instanceof 的优先级比!运算符低，所以 ! key in someObject 是错误的

### 数组

1. 不要使用new Array的形式来创建数组，除非是new Array(size:number)的情况

2. 不要使用有空洞的数组

    ```typescript
    //错误
    const a = [1, , ,4];
    const b = [ , , ];
    
    //正确
    const a = [];
    a[0] = 1;
    a[3] = 4;
    const b = new Array(3);
    ```

    

3. 使用includes方法，而不是indexof 方法来判断数组里面是否有某元素

4. 调用数组的sort方法时，不能忽略compare参数

### 对象

1. 不要使用Object.assign来对一个字面量常量对象赋值，直接使用 `…`语法
2. 对象声明的时候，尽量使用shorthand语法，除非属性/方法名需要加引号
3. 调用对象中的hasOwnProperty, isPrototypeOf, propertyIsEnumerable的方法时，应该使用Reflect或者Object.prototype上的方法，而不是直接对对象调用

### 类

1. 类的成员函数需要使用this，否则尽量声明成静态成员
2. 类如果继承了基类，则构造函数必须调用super()方法
3. 子类的成员函数，在调用super() 之前，不能调用this和super的方法
4. 类成员必须指定访问级别，不能用默认的public
5. 类成员按照以下规则排序：属性>构造函数>方法，同一种类型的成员，静态>非静态，public>protected>private
6. 不要滥用getter和setter

### 函数

1. 函数的每个路径都应该有return，而且如果函数的类型不是void，应该要return值

2. 使用函数表达式 

    ```typescript
    //正确
    const myFunc = function myFunc(){}
    
    //错误
    function myFunc(){}
    
    ```

    

3. 重载函数时，所有声明和实现放在一起

4. 立即执行的函数，在函数调用外加括号（新的语法中，极少需要用到立即执行函数的情况）

5. 不要写空函数

6. 不要通过Function来创建一个函数

7. 尽量避免修改函数的参数

8. 不要在函数的return语句中进行赋值操作

9. 避免有歧义的箭头函数，如果有遇到这样的情况，应该使用括号

10. callback函数尽量使用箭头函数

11. 要将数组展开作为函数参数的时候，用func(…args)这样的方式，而不是func.apply(nul,args)

12. 用箭头函数来代替将this存到scope中的变量中

13. 需要使用this的function函数，如果赋值给变量，要注意this的上下文环境会被破坏

14. 不要使用可以合并的重载函数

    ```typescript
    //错误
    function f(a:number);
    function f(a:string);
    function f(a){
        // some code
    }
    
    //正确
    function f(a:number|string){}
    
    ```

    

### 类型

1. 不能使用Array, Object, String, Number,Boolean作为类型，应该使用[],{},string, number,boolean
2. 除函数的rest参数外，不要使用any类型。
3. 尽量使用unknown来代替any
4. 变量、参数、属性的类型，如果能通过初始化的语句推断出来，则不要写类型
5. 定义一个类的静态部分的interface时，指定构造函数的类型要用 new ，而不是constructor
6. 泛型的类型参数有默认值的时候，使用默认值的情况下不要指定

### 判断和条件语句

1. 不要和  -0 进行比较
2. 不要在条件语句中赋值， while ((a = func(a)) !== 0 ) 这样的形式除外（允许但没有必要）
3. 除了循环外，其他情况不要使用结果为常量的判断语句
4. 如果else里面只有一个if语句，使用else if 
5. 当字面量和变量进行比较的时候，将变量写在运算符的左侧
6. 不要和NaN进行比较，应该使用isNaN方法
7. boolean不要和true/false比较
8. string和number 类型不能省略逻辑运算符

### 循环语句

1. 循环中的函数不能依赖scope外的变量

### switch/case语句

1. 必须要有default

2. 除了空的case和最后一个case，必须要有break。如果确实需要继续执行下一个case的内容，要加上注释 // fallsthrough

    ```typescript
    //错误
    switch (arr.lenght) {
        case 1:
            newArr.push(arr[0]);
        case 2:
            newArr.push(arr[1]);
        //...
    }
    
    //正确
    switch (arr.lenght) {
        case 1:
            newArr.push(arr[0]);
            // fallsthrough
        case 2:
            newArr.push(arr[1]);
            
        //...
    }
    
    ```

       

3. case 语句中如果要定义变量，需要放到block里面

4. 不能有重复的case语句

### async/await ,promise 和generator

1. 对于async函数的调用，需要加上await，函数的结果作为另一个promise返回的情况除外
2. promise的callback函数不能是async 函数
3. 循环中await async函数，并不能实现并发，如果要实现并发，使用promise.all
4. await后面必须是PromiseLike的对象
5. Promise的reject如果有参数，参数必须是Error类型
6. async函数的return 中不要用await，在return中的await多余
7. generator函数的函数体应该包含yield
8. 表达式中如果同时用到scope外的变量和 yiled/await 可能会产生竞争
9. promise 中抛出的异常，不能被外部的try…catch捕捉到，要注意promise中的异常处理
10. 返回promise的函数，应该声明为async函数
11. 减少使用generator

### 异常处理

1. throw 的目标必须是Error对象
2. catch语句里面不能只直接把异常再抛出
3. 不能在catch里面修改抛出来的异常对象
4. 在try/catch语句里面，如果有return或者throw语句，则在finally中的return/throw语句可能会让结果和看起来不一样

### 正则表达式

1. 正则表达式中不要使用控制字符
2. 正则表达式中如果有连续空格，使用 / {m,n}/的语法进行匹配
3. 使用RegExp.exec 而不是String.match来进行正则表达式匹配
4. 正则表达式里，使用[]语法时，[]里面不能是空
5. 正则表达式的[]里面使用unicode字符，可能会出错

### 不必要/无意义的代码

1. 不必要的三元表达式

2. if 中如果return了，就不需要写else了

3. 不要写不产生任何变量的定义语句

    ```typescript
    //错误
    let {a:{}} = foo; //这里并不会产生一个a的变量
    
    ```

    

4. 在对一个函数调用bind之前，注意bind是否有意义

5. 不允许独立存在的代码块

6. 单独的new语句不产生任何效果（不应该只为了执行构造函数而new）

7. `a = a` 这样的赋值语句

8. `a === a` 这样的判断语句

9. 无用的表达式(表达式的值没有赋值给任何变量，也没有函数调用)，例如

    ```typescript
    a || b;
    "somestring"
    
    ```

    

10. 减少无用的转义字符，例如

    ```typescript
    "\'"
    `\"`
    
    ```

    

11. 声明对象使用computed key的时候，key不能是常量

12. 空的构造函数，或者直接将所有参数传递给super的构造函数是不必要的

13. 在import和声明变量的时候，如果不需要在destructure的时候重命名，不要使用重命名的语法

14. 不要有空的代码块（有注释的情况会忽略）

15. 不需要用Boolean来转换成布尔值

16. 减少不必要的()，除非能()能使代码意图或优先级更清晰

17. 不要定义空的interface

18. 不要定义无效的类（没有成员的类，只有构造函数的类，只有静态成员的类）

19. 不要使用不必要的类型断言

## 使用方式

1. 安装包
    ```sh
    yarn add @luban/linter
    ```

1. 运行命令

    ```sh
    # 安装/更新配置文件(安装包的时候会自动执行)
    yarn lint-install

    # 默认检查src目录
    yarn lint 

    # 检查指定目录/文件
    yarn lint folder1 file2

    # 自动修复
    yarn lint-fix 

    # 自动修复指定目录/文件
    yarn lint-fix folder1 file2
    
    ```

## 版本记录

### v1.0  20190911

初始版本  

### v1.1 20190911

增加工具配置 

v1.2 20190912

修改格式，以支持大纲视图

修改和增加部分建议规则

v1.3 20190916
增加通过包的方式引用
去除shell的安装方式说明

v1.4 20190919
现在在安装包的时候就会自动执行install,无需单独执行install  
修改命令为`lint`,`lint-fix`,`lint-install`  
